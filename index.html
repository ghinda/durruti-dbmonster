<html>
<head>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="link">
  You're looking at a Durruti<br>
  version of <a href="https://dbmonster.firebaseapp.com/">DBMonster</a>.<br>
  <a class="center" href="https://github.com/ghinda/durruti-dbmonster">See it on GitHub</a>
</div>

<div id="body">
</div>

<script src="ENV.js"></script>
<script src="durruti.min.js"></script>
<script src="store.min.js"></script>

<script src="http://localvoid.github.io/perf-monitor/0.1/perf-monitor.js"></script>

<script type="text/javascript">
  var rows = []

  function Main () {
    this.render = function () {
      return `
        <table class="table table-striped latest-data">
          <tbody>

          ${rows.map(function (rowStore, index) {
            var row = new Row(rowStore)

            return durruti.render(row)
          }).join('')}

          </tbody>
        </table>
      `
    }
  }

  function Row (store) {
    var self = this
    self.data = store.get()

    function change () {
      self.data = store.get()

      // for better performance,
      // manually update the text content in the row,
      // instead of just using durruti.render(...).
      var $count = self.$container.querySelector('.query-count span')
      var $query = self.$container.querySelectorAll('.Query')

      $count.className = self.data.lastSample.countClassName
      $count.textContent = self.data.lastSample.nbQueries

      self.data.lastSample.topFiveQueries.map(function (col, i) {
        $query[i].className = 'Query ' + col.elapsedClassName
        $query[i].firstChild.textContent = col.formatElapsed
        $query[i].querySelector('.popover-content').textContent = col.query
      })

      // this is slower, because it re-renders the entire row node.
      // durruti.render(self, self.$container)
    }

    self.mount = function ($container) {
      self.$container = $container
      store.on('change', change)
    }

    self.unmount = function () {
      store.off('change', change)
    }

    self.render = function () {
      return `
        <tr>
          <td class="dbname">
            ${self.data.dbname}
          </td>

          <td class="query-count">
            <span class="${self.data.lastSample.countClassName}">
              ${self.data.lastSample.nbQueries}
            </span>
          </td>

          ${self.data.lastSample.topFiveQueries.map(function (col) {
            return `
            <td class="Query ${col.elapsedClassName}">
              ${col.formatElapsed}
              <div class="popover left">
                <div class="popover-content">${col.query}</div>
                <div class="arrow"></div>
              </div>
            </td>
            `
          }).join('')}
        </tr>
      `
    }
  }

  function setStoreData (data) {
    data.forEach(function (rowData, i) {
      if (!rows[i]) {
        rows[i] = new durruti.Store('', {
          history: false
        })

        rows[i].set(rowData)
      } else if(rows[i].get().lastSample.nbQueries !== rowData.lastSample.nbQueries) {
        // if row data has changed
        rows[i].set(rowData)
      }
    })
  }

  perfMonitor.startFPSMonitor();
  perfMonitor.startMemMonitor();
  perfMonitor.initProfiler('view update');

  setStoreData(ENV.generateData().toArray())

  durruti.render(Main, document.querySelector('#body'))

  function redraw() {
    perfMonitor.startProfile('view update');

    setStoreData(ENV.generateData().toArray());

    perfMonitor.endProfile('view update');
    setTimeout(redraw, ENV.timeout);
  }

  redraw();
</script>

</body>
</html>
